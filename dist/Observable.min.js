/* ObservableObject - v0.0.1 - 2015-04-15
 * Homepage: http://oo.panyushk.in/
 * Author: Misha Panyushkin <misha.panyushkin@gmail.com>
 * Copyright.*/

!function(a,b){function c(a){"knot"==g.prototype.getNodeRawType(a)&&new h({raw:a,"super":this,name:"val"})}function d(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.time=+new Date}function e(){}function f(){e.call(this)}function g(){}function h(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.type="knot",this.isKnot(this.raw)&&(this.val=new f,this.createObservableNodeProperty(),this.createNodeFromRaw(this.raw))}function i(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.type="leaf",this.isLeaf(this.raw[this.name])&&(this.val=this.raw[this.name],this.createObservableNodeProperty())}function j(a){return new c(a)}c.prototype.bubbleUpNodeEvent=function(a){console.log(a)},f.prototype=Object.create(e.prototype),g.prototype=Object.create(c.prototype),g.prototype.getNodeRawType=function(a){switch(Object.prototype.toString.call(a).slice(8,-1)){case"Object":return"knot";default:return"leaf"}},g.prototype.createNodeFromRaw=function(a){for(var b in a)if(a.hasOwnProperty(b))switch(this.getNodeRawType(a[b])){case"knot":new h({raw:a[b],"super":this,name:b});break;case"leaf":new i({raw:a,"super":this,name:b})}},g.prototype.bubbleUpNodeEvent=function(a){this["super"].bubbleUpNodeEvent(a)},g.prototype.createNodeEvent=function(a,b,c,e){this.last_event=new d({type:a,name:b,value:{before:c,after:e}}),this.bubbleUpNodeEvent(this.last_event)},g.prototype.lookupForAddedNodes=function(){for(var a in this.val)if(this.val.hasOwnProperty(a)&&!this.raw[a])switch(this.raw[a]=this.val[a],this.createNodeEvent("add",a,void 0,this.raw[a]),this.getNodeRawType(this.raw[a])){case"knot":new h({raw:this.raw[a],"super":this,name:a});break;case"leaf":new i({raw:this.raw,"super":this,name:a})}},g.prototype.lookupForRemovedNodes=function(){var a;for(var b in this.raw)this.raw.hasOwnProperty(b)&&!this.val[b]&&(a=this.raw[b],delete this.raw[b],this.createNodeEvent("delete",b,a,void 0))},g.prototype.getNodeValue=function(){return"knot"==this.type&&setTimeout(function(){this.lookupForAddedNodes(),this.lookupForRemovedNodes()}.bind(this)),this.val},g.prototype.setNodeValue=function(a){switch(this.raw[this.name]=a,this.val!==a&&this.createNodeEvent("update",this.name,this.val,a),this.getNodeRawType(this.raw[this.name])){case"knot":new h({raw:this.raw[this.name],"super":this["super"],name:this.name});break;case"leaf":this.val=a}},g.prototype.createObservableNodeProperty=function(){Object.defineProperty(this["super"].val||this["super"],this.name,{get:this.getNodeValue.bind(this),set:this.setNodeValue.bind(this),configurable:1})},h.prototype=Object.create(g.prototype),h.prototype.isKnot=function(a){return this.getNodeRawType(a)==this.type},i.prototype=Object.create(g.prototype),i.prototype.isLeaf=function(a){return this.getNodeRawType(a)==this.type},(a||b).Observe=j}(this,this);