/* ObservableObject - v0.0.1 - 2015-04-14
 * Homepage: http://oo.panyushk.in/
 * Author: Misha Panyushkin <misha.panyushkin@gmail.com>
 * Copyright.*/

!function(a,b){function c(a){"knot"==d.prototype.getNodeRawType(a)&&new f({raw:a,"super":this,name:"val"})}function d(){}function e(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.time=+new Date}function f(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.type="knot",this.isKnot(this.raw)&&(this.val={},this.createObservableNodeProperty(),this.createNodeFromRaw(this.raw))}function g(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.type="leaf",this.isLeaf(this.raw[this.name])&&(this.val=this.raw[this.name],this.createObservableNodeProperty())}function h(a){return new c(a)}c.prototype.bubbleUpNodeEvent=function(a){console.log(a)},d.prototype=Object.create(c.prototype),d.prototype.getNodeRawType=function(a){switch(Object.prototype.toString.call(a).slice(8,-1)){case"Object":return"knot";default:return"leaf"}},d.prototype.createNodeFromRaw=function(a){for(var b in a)if(a.hasOwnProperty(b))switch(this.getNodeRawType(a[b])){case"knot":new f({raw:a,"super":this,name:b});break;case"leaf":new g({raw:a,"super":this,name:b})}},d.prototype.bubbleUpNodeEvent=function(a){this["super"].bubbleUpNodeEvent(a)},d.prototype.createNodeEvent=function(a,b,c,d){this.last_event=new e({type:a,name:b,value:{before:c,after:d}}),this.bubbleUpNodeEvent(this.last_event)},d.prototype.lookupForAddedNodes=function(){for(var a in this.val)if(this.val.hasOwnProperty(a)&&!this.raw[a])switch(this.raw[a]=this.val[a],this.createNodeEvent("add",a,void 0,this.raw[a]),this.getNodeRawType(this.raw[a])){case"knot":new f({raw:this.raw[a],"super":this,name:a});break;case"leaf":new g({raw:this.raw,"super":this,name:a})}},d.prototype.lookupForRemovedNodes=function(){var a;for(var b in this.raw)this.raw.hasOwnProperty(b)&&!this.val[b]&&(a=this.raw[b],delete this.raw[b],this.createNodeEvent("delete",b,a,void 0))},d.prototype.getNodeValue=function(){return"knot"==this.type&&setTimeout(function(){this.lookupForAddedNodes(),this.lookupForRemovedNodes()}.bind(this)),this.val},d.prototype.setNodeValue=function(a){switch(this.raw[this.name]=a,this.val!==a&&this.createNodeEvent("update",this.name,this.val,a),this.getNodeRawType(this.raw[this.name])){case"knot":new f({raw:this.raw[this.name],"super":this["super"],name:this.name});break;case"leaf":this.val=a}},d.prototype.createObservableNodeProperty=function(){Object.defineProperty(this["super"].val||this["super"],this.name,{get:this.getNodeValue.bind(this),set:this.setNodeValue.bind(this),configurable:1})},f.prototype=Object.create(d.prototype),f.prototype.isKnot=function(a){return this.getNodeRawType(a)==this.type},g.prototype=Object.create(d.prototype),g.prototype.isLeaf=function(a){return this.getNodeRawType(a)==this.type},(a||b).Observable=h}(this,this);